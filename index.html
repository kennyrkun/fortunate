<!DOCTYPE html>
<html>
	<head>
		<title>23fAd4c</title>

		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
		
		<script src="https://kerrishaus.com/assets/scripts/jquery-3.6.0.min.js"></script>
        
		<script src="https://portal.kerrishaus.com/assets/javascript/messages.js"></script>
		<link rel="stylesheet" href="https://portal.kerrishaus.com/assets/styles/messages.css">

		<link rel="stylesheet" href="https://portal.kerrishaus.com/assets/styles/flex-utility.css">

		<script src="./scripts/thirdparty/imageMapResizer.min.js"></script>
		<link rel="stylesheet" href="./styles/environment.css">
		<link rel="stylesheet" href="./styles/dialog.css">
	</head>

	<body>
	    <style>
	        html, body
	        {
	            padding: 0;
	            margin: 0;
	            
	            background: black;
	            
	            max-width: 100vw;
	            max-height: 100vh;
	            
	            overflow: hidden;
	        }
	    </style>
	    
		<script type="module" id="game">
		    import { StateMachine } from "./scripts/states/StateMachine.js";
		    import { State        } from "./scripts/states/State.js";

			import { EnvironmentManager } from "./scripts/EnvironmentManager.js";
			import { CharacterManager } from "./scripts/CharacterManager.js";
			import { DialogManager } from "./scripts/DialogManager.js";
			
			import { EnvironmentNavigationState } from "./scripts/states/EnvironmentNavigationState.js";
		    
		    let sleepSetTimeout_ctrl;

            window.sleep = function(ms)
            {
                clearInterval(sleepSetTimeout_ctrl);
                return new Promise(resolve => sleepSetTimeout_ctrl = setTimeout(resolve, ms));
            }
            
            // TODO: support scaled image
			function getPixel(img, x, y) 
			{
				let canvas = document.createElement('canvas');
				canvas.width = 1;
				canvas.height = 1;
				canvas.getContext('2d').drawImage(img, x, y, 1, 1, 0, 0, 1, 1);;
				let pixelData = canvas.getContext('2d').getImageData(0, 0, 1, 1).data;
				canvas.remove();

				return pixelData;
			}

			$(document).mousemove((event) => 
			{
				for (const environment of envMan.environments.values())
				{
				    if ("click" in environment.environment)
					    environment.element.toggleClass("hovering", getPixel(environment.element[0], event.clientX, event.clientY)[3] > 0);
				}
			});
		    
		    window.stateMachine     = new StateMachine();

		    window.envMan           = new EnvironmentManager();

			window.dialogManager    = new DialogManager();
			await dialogManager.loadDialog();

			window.characterManager = new CharacterManager();
			await characterManager.loadCharacters();
		    
		    stateMachine.pushState(new EnvironmentNavigationState([
				{
					id: 1
				},
				{
					id: 3,
					click: {
						action: "dialog",
						character: 1,
						dialog: 1
					}
				},
				{
					id: 2,
					click: {
						action: "dialog",
						character: 2,
						dialog: 2
					}
				}
			], 0));
		</script>
	</body>
</html>