<!DOCTYPE html>
<html>
	<head>
		<title>23fAd4c</title>

		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
		
		<script src="https://kerrishaus.com/assets/scripts/jquery-3.6.0.min.js"></script>
        
		<script src="https://portal.kerrishaus.com/assets/javascript/messages.js"></script>
		<link rel="stylesheet" href="https://portal.kerrishaus.com/assets/styles/messages.css">

		<link rel="stylesheet" href="https://portal.kerrishaus.com/assets/styles/flex-utility.css">

		<script src="./imageMapResizer.min.js"></script>

		<link rel="stylesheet" href="./environment.css">
	</head>

	<body>
	    <div id="environments" style="display: none;">
	    </div>
	    
	    <div id="characters">
	    </div>
	    
	    <div id="dialogBox">
	    </div>
	    
	    <div id="dialogChoiceBox">
	    </div>
	    
	    <style>
	        html, body
	        {
	            padding: 0;
	            margin: 0;
	            
	            background: black;
	            
	            max-width: 100vw;
	            max-height: 100vh;
	            
	            overflow: hidden;
	        }
	    
	        #environments img
	        {
	            width: 100vw;
	            max-height: 100vh;
	        }
	    </style>
	
		<script type="module" id="game">
		    import { StateMachine } from "./StateMachine.js";
		    import { State        } from "./State.js";
		
		    class EnvironmentManager
		    {
		        constructor()
		        {
		            this.environments = new Map();
		        }
		        
		        addEnvironment(environment, fadeTime = 3000)
		        {
					this.environments.set(environment.id, environment);

		            setTimeout(() => 
		            {
    		            $("#environments").append(environment.element);
    		            
    		            $("#environments").fadeIn(fadeTime);
		            }, fadeTime);
		            
		            return environment;
		        }
		        
		        clearEnvironments(fadeTime = 3000)
		        {
	                $("#environments").empty()
					
					// TODO: these will not fade out because it's cleared before this is run
					for (let environment of $("#environments").children())
						$(environment).fadeOut(fadeTime);

					this.environments.clear();
		        }
		        
				/*
		        changeEnvironment(environment, fadeTime = 3000)
		        {
					this.environments[environment.id] = environment;

		            if ($("#environments").children().length > 0)
		                $("#environments").fadeOut(fadeTime);
		            
		            setTimeout(() => 
		            {
		                clearEnvironments();
		                
    		            $("#environments").append(environment.element);
    		            
    		            $("#environments").fadeIn(fadeTime);
		            }, fadeTime);
		            
		            return environment;
		        }
				*/
		    }
		    
		    class Environment
		    {
		        constructor(environment)
		        {
					this.environment = environment;
		            this.id  = environment.id;
		            this.src = `env${this.id}.png`;
		            
		            // TODO: load then append
		            this.element = $(`<img src="env${this.id}.png" id="environment-${this.id}" class="environment" usemap="#map${this.id}">`);

					if (this.id == 2)
						this.element.append(`
							<map name="map${this.id}">
								<area target="_blank" href="test1.html" onmouseover="console.log("hover 1");" onclick="console.log("click 1");" coords="150,590,37,544" shape="rect">
							</map>`);
					else if (this.id == 3)
						this.element.append(`
							<map name="map${this.id}">
								<area target="_blank" href="test2.html" onmouseover="console.log("hover 2");" onclick="console.log("click 2");" coords="411,700,502,655,555,637,587,617,576,601,581,596,595,596,632,592,648,592,596,600,604,612,622,618,603,659,613,679,632,698" shape="poly">
							</map>`);
		        }
		    }
		    
		    class EnvironmentNavigationState extends State
		    {
		        init(environments)
		        {
					for (let environment of environments)
        		    	envMan.addEnvironment(new Environment(environment), 0);
		        }
		    }
		    
		    class SingleCharacterDialogState extends State
		    {
		        init(characterId, dialogId)
		        {
		            this.character = new Character(characterId);
		            this.dialogBox = new DialogBox(dialogId);
		            
		            this.character.show();
		            this.dialogBox.show();
		        }
		    }
		    
		    class Character
		    {
		        constructor(characterId)
		        {
		            this.id = characterId;
		            
		            this.element = $(`<img src="chr${this.id}.png" id="character${this.id}" class="character" style="display: none">`).appendTo("#characters");
		        }

				show(fadeTime = 3000)
				{
		            element.fadeIn(fadeTime);
				}

				hide(fadeTime = 3000)
				{
					element.fadeOut(fadeTime);
				}
		    }
		    
		    class DialogBox
		    {
		        constructor(dialogId)
		        {
		            $("#dialogBoxes").append(`<div class="" id="dialog${dialogId}">Dialog</div>`);
		        }
		    }
		    
		    class DialogChoiceBox
		    {
		        constructor()
		        {
		            
		        }
		    }
		    
		    class Dialog
		    {
		        constructor(id, text)
		        {
		            this.id   = id;
		            this.text = test;
		        }
		        
		        display()
		        {
		            
		        }
		        
		        hide()
		        {
	            
		        }
		    }

			imageMapResize();

			/*
			function getPixel(img, x, y) 
			{
				let canvas = document.createElement('canvas');
				canvas.width = 1;
				canvas.height = 1;
				canvas.getContext('2d').drawImage(img, x, y, 1, 1, 0, 0, 1, 1);;
				let pixelData = canvas.getContext('2d').getImageData(0, 0, 1, 1).data;
				canvas.remove();

				return pixelData;   
			}

			$(document).mousemove((event) => 
			{
				for (const environment of envMan.environments.values())
				{
					environment.element.toggleClass("hover", getPixel(environment.element[0], event.clientX, event.clientY)[3] > 0);
				}
			});
			*/
		    
		    const MOUNTAIN_ENVIRONMENT = 1;
		    
		    window.stateMachine = new StateMachine();
		    window.envMan       = new EnvironmentManager();
		    
		    stateMachine.pushState(new EnvironmentNavigationState([
				{
					id: 1
				},
				{
					id: 2,
					click: {
						action: "dialog",
						character: 1,
						dialog: 1
					}
				},
				{
					id: 3,
					click: {
						action: "dialog",
						character: -1,
						dialog: 2
					}
				}
			]));
		    
		    setTimeout(() => {
		        $("#environments").children()[0].click();
		    }, 10000);
		</script>
	</body>
</html>